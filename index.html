<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gourmet Finder - Votre Guide Gastronomique Mondial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6536893719603715"
     crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(to right, #4ade80, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
        }
        .chat-bubble-gemini {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2a364d;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }
        .star-rating label {
            cursor: pointer;
            color: #4b5563; /* Gray stars */
            transition: color 0.2s;
            font-size: 2rem;
            line-height: 1;
        }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #f59e0b; /* Yellow stars */
        }
        .star-rating input {
            display: none;
        }
        .filter-btn[data-active="true"] {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 min-h-screen">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl md:text-5xl font-extrabold gradient-text">Gourmet Finder</h1>
            <p class="text-slate-400 mt-2">Votre guide gastronomique mondial, propulsé par Gemini & Google.</p>
            <div class="absolute top-0 right-0 flex space-x-2">
                <button id="open-recipe-modal-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                    Recette du Jour
                </button>
                <button id="open-about-modal-btn" class="bg-slate-800 hover:bg-slate-700 text-slate-300 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                    À Propos & Avis
                </button>
            </div>
        </header>

        <!-- Search and Filters (Contenu inchangé) -->
        <div class="sticky top-0 z-20 bg-slate-900/80 backdrop-blur-lg py-4 mb-4">
            <form id="search-form" class="max-w-3xl mx-auto mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="city-input" placeholder="Ville ou Région (ex: Paris)" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2.5 px-4 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <input type="text" id="specific-search-input" placeholder="Plat ou nom de restaurant (ex: Pizza)" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2.5 px-4 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </form>
            <div class="max-w-4xl mx-auto">
                 <div class="mb-4">
                    <p class="text-sm font-semibold text-slate-400 mb-2 text-center">Filtres populaires</p>
                    <div id="tag-filters" class="flex flex-wrap justify-center gap-2">
                         <button class="filter-btn border border-slate-600 bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-xs font-semibold transition-all" data-value="gastronomique">Gastronomique</button>
                         <button class="filter-btn border border-slate-600 bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-xs font-semibold transition-all" data-value="étoilé Michelin">Étoilé Michelin</button>
                         <button class="filter-btn border border-slate-600 bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-xs font-semibold transition-all" data-value="Bib Gourmand">Bib Gourmand</button>
                         <button class="filter-btn border border-slate-600 bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-xs font-semibold transition-all" data-value="chaleureux">Chaleureux</button>
                         <button class="filter-btn border border-slate-600 bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-xs font-semibold transition-all" data-value="bien noté">Bien noté</button>
                         <button class="filter-btn border border-slate-600 bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-xs font-semibold transition-all" data-value="pizzeria">Pizzeria</button>
                         <button class="filter-btn border border-slate-600 bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-xs font-semibold transition-all" data-value="kebab">Kebab</button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <select id="sort-select" class="bg-slate-800 border border-slate-700 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Trier par pertinence</option>
                        <option value="du plus cher au moins cher">Prix : Décroissant</option>
                        <option value="du moins cher au plus cher">Prix : Croissant</option>
                        <option value="les mieux notés">Meilleure note</option>
                    </select>
                    <button id="search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21 21-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"></path></svg>
                        Rechercher
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section (Contenu inchangé) -->
        <main id="results-container" class="max-w-7xl mx-auto">
            <div id="loader" class="hidden justify-center items-center py-16"><div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500"></div></div>
            <div id="initial-message" class="text-center py-16 text-slate-500"><p>Utilisez les filtres ci-dessus pour lancer une recherche détaillée.</p></div>
            <div id="error-message" class="hidden text-center py-16 text-red-400"></div>
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </main>
    </div>

    <!-- Details Modal (Contenu inchangé) -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4"><div id="modal-content" class="bg-slate-800 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl relative"></div></div>
    
    <!-- About & Reviews Modal (Contenu inchangé) -->
    <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl relative p-8">
            <button id="close-about-modal-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white z-10 bg-slate-900/50 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <main>
                <section id="features" class="mb-16">
                    <h2 class="text-4xl font-bold text-center mb-12 gradient-text">Une Révolution dans votre Assiette</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                         <div class="bg-slate-900 p-6 rounded-xl text-center"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-green-400"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg><h3 class="text-xl font-bold mb-2">Recherche Mondiale</h3><p class="text-slate-400 text-sm">Trouvez les perles rares, des restaurants aux boutiques spécialisées, dans n'importe quelle ville du monde.</p></div>
                         <div class="bg-slate-900 p-6 rounded-xl text-center"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-green-400"><path d="M21.5 12H16c-.7 2-2 3-4 3s-3.3-1-4-3H2.5"></path><path d="M5.5 5.1L2 12v6c0 1.1.9 2 2 2h16a2 2 0 002-2v-6l-3.4-6.9A2 2 0 0016.8 4H7.2a2 2 0 00-1.7 1.1z"></path></svg><h3 class="text-xl font-bold mb-2">Détails Complets</h3><p class="text-slate-400 text-sm">Accédez aux menus, prix, notes, adresses, photos et itinéraires pour faire le bon choix.</p></div>
                         <div class="bg-slate-900 p-6 rounded-xl text-center"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-green-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg><h3 class="text-xl font-bold mb-2">Assistant Culinaire</h3><p class="text-slate-400 text-sm">Notre chatbot répond à tout : recettes, accords mets-vins, histoire d'un plat, etc.</p></div>
                         <div class="bg-slate-900 p-6 rounded-xl text-center"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-green-400"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"></path></svg><h3 class="text-xl font-bold mb-2">Avis Communautaires</h3><p class="text-slate-400 text-sm">Partagez vos expériences et consultez celles des autres pour des choix toujours plus éclairés.</p></div>
                    </div>
                </section>
                <section id="reviews">
                    <h2 class="text-4xl font-bold text-center mb-12">La Communauté des Gourmets</h2>
                    <div class="grid lg:grid-cols-2 gap-12">
                        <div class="bg-slate-900 p-8 rounded-2xl"><h3 class="text-2xl font-bold mb-6">Partagez votre expérience</h3><form id="review-form"><div class="mb-4"><label for="reviewer-name" class="block mb-2 text-sm font-medium text-slate-300">Votre nom</label><input type="text" id="reviewer-name" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ex: Jean Dupont" required></div><div class="mb-4"><label for="place-name" class="block mb-2 text-sm font-medium text-slate-300">Nom du lieu</label><input type="text" id="place-name" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ex: Le Bistrot Gourmand" required></div><div class="mb-4"><label class="block mb-2 text-sm font-medium text-slate-300">Votre note</label><div class="star-rating"><input type="radio" id="star5" name="rating" value="5" required/><label for="star5" title="5 stars">★</label><input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">★</label><input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars">★</label><input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">★</label><input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">★</label></div></div><div class="mb-6"><label for="review-text" class="block mb-2 text-sm font-medium text-slate-300">Votre avis</label><textarea id="review-text" rows="4" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Écrivez votre avis ici..." required></textarea></div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Publier mon avis</button></form></div>
                        <div id="reviews-list" class="space-y-6"><div class="bg-slate-900 p-6 rounded-xl"><div class="flex items-start justify-between mb-2"><div><p class="font-bold text-lg">Marie Claire</p><p class="text-sm text-slate-400">sur "La Trattoria del Ponte"</p></div><div class="text-yellow-400 text-xl">★★★★★</div></div><p class="text-slate-300 mb-4">Une expérience incroyable ! Les pâtes aux truffes étaient divines. Service impeccable. Je recommande vivement !</p><div class="text-right"><button class="reply-btn text-sm text-blue-400 hover:underline">Répondre</button></div><div class="reply-section hidden mt-4 pl-6 border-l-2 border-slate-700"></div></div></div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <!-- NOUVEAU: Recipe of the Day Modal -->
    <div id="recipe-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl relative">
            <button id="close-recipe-modal-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white z-10 bg-slate-900/50 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            
            <div id="recipe-loader" class="flex flex-col items-center justify-center h-96">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-green-500"></div>
                <p class="mt-4 text-slate-400">Génération de la recette du jour...</p>
            </div>
            
            <div id="recipe-content" class="hidden">
                <!-- Le contenu de la recette sera injecté ici -->
            </div>

            <div id="recipe-feedback-section" class="p-8 border-t border-slate-700">
                <h3 class="text-2xl font-bold mb-6 text-green-400">Avis sur la recette</h3>
                
                <div id="recipe-avg-rating" class="mb-6 text-center">
                    <!-- Note moyenne injectée ici -->
                </div>
                
                <form id="recipe-feedback-form" class="mb-8">
                    <h4 class="text-lg font-semibold mb-4">Laissez votre avis</h4>
                    <div class="mb-4">
                        <label for="recipe-reviewer-name" class="block mb-2 text-sm font-medium text-slate-300">Votre nom</label>
                        <input type="text" id="recipe-reviewer-name" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ex: Jean Dupont" required>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 text-sm font-medium text-slate-300">Votre note</label>
                        <div class="star-rating">
                            <input type="radio" id="rstar5" name="recipe-rating" value="5" required/><label for="rstar5" title="5 stars">★</label>
                            <input type="radio" id="rstar4" name="recipe-rating" value="4" /><label for="rstar4" title="4 stars">★</label>
                            <input type="radio" id="rstar3" name="recipe-rating" value="3" /><label for="rstar3" title="3 stars">★</label>
                            <input type="radio" id="rstar2" name="recipe-rating" value="2" /><label for="rstar2" title="2 stars">★</label>
                            <input type="radio" id="rstar1" name="recipe-rating" value="1" /><label for="rstar1" title="1 star">★</label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="recipe-comment-text" class="block mb-2 text-sm font-medium text-slate-300">Commentaire</label>
                        <textarea id="recipe-comment-text" rows="3" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="J'ai adoré cette recette !" required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Envoyer</button>
                </form>
                
                <div id="recipe-feedback-list" class="space-y-4 max-h-60 overflow-y-auto">
                    <!-- Commentaires injectés ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot (Contenu inchangé) -->
    <div id="chatbot-container">
        <button id="chatbot-toggle" class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-lg transition-transform hover:scale-110"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></button>
        <div id="chatbot-window" class="hidden fixed bottom-24 right-6 w-[90vw] max-w-sm h-[60vh] bg-slate-800 rounded-2xl shadow-2xl flex flex-col transition-all origin-bottom-right">
            <div class="flex items-center justify-between p-4 bg-slate-700 rounded-t-2xl"><h3 class="font-bold text-lg">Assistant Gourmet</h3><button id="chatbot-close" class="text-slate-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-3"><div class="chat-bubble-gemini p-3 rounded-lg max-w-xs">Bonjour ! Demandez-moi une recette ou posez-moi une question culinaire.</div></div>
            <div id="chat-loader" class="hidden p-4 flex items-center space-x-2"><div class="chat-bubble-gemini p-3 rounded-lg"><div class="flex items-center space-x-1"><span class="w-2 h-2 bg-slate-500 rounded-full animate-bounce " style="animation-delay: 0s;"></span><span class="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></span><span class="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></span></div></div></div>
            <form id="chat-form" class="p-4 border-t border-slate-700"><div class="relative"><input type="text" id="chat-input" placeholder="Votre message..." class="w-full bg-slate-700 border border-slate-600 rounded-full py-2 pl-4 pr-12 text-white placeholder-slate-400 focus:ring-2 focus:ring-green-500 focus:outline-none"><button type="submit" class="absolute top-1/2 right-2 -translate-y-1/2 text-green-400 hover:text-green-300 p-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></div></form>
        </div>
    </div>

    <!-- Passage en type="module" pour inclure les imports Firebase -->
    <script type="module">
        console.log("Gourmet Finder script loading..."); // Ligne ajoutée pour forcer le rafraîchissement
        
        // --- Imports Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variables Firebase Globales ---
        let db, auth, appId, userId;
        let unsubscribeFeedback; // Pour arrêter l'écouteur onSnapshot

        // --- DOM Elements (Recherche) ---
        const cityInput = document.getElementById('city-input');
        const specificSearchInput = document.getElementById('specific-search-input');
        const tagFiltersContainer = document.getElementById('tag-filters');
        const sortSelect = document.getElementById('sort-select');
        const searchButton = document.getElementById('search-button');
        const resultsGrid = document.getElementById('results-grid');
        const initialMessage = document.getElementById('initial-message');
        const errorMessage = document.getElementById('error-message');
        const loader = document.getElementById('loader');
        
        // --- DOM Elements (Modales) ---
        const detailsModal = document.getElementById('details-modal');
        const modalContent = document.getElementById('modal-content');
        const aboutModal = document.getElementById('about-modal');
        const openAboutModalBtn = document.getElementById('open-about-modal-btn');
        const closeAboutModalBtn = document.getElementById('close-about-modal-btn');
        
        // --- DOM Elements (Chatbot) ---
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotWindow = document.getElementById('chatbot-window');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const chatLoader = document.getElementById('chat-loader');

        // --- DOM Elements (Avis) ---
        const reviewForm = document.getElementById('review-form');
        const reviewsList = document.getElementById('reviews-list');

        // --- NOUVEAU: DOM Elements (Recette du Jour) ---
        const openRecipeModalBtn = document.getElementById('open-recipe-modal-btn');
        const closeRecipeModalBtn = document.getElementById('close-recipe-modal-btn');
        const recipeModal = document.getElementById('recipe-modal');
        const recipeLoader = document.getElementById('recipe-loader');
        const recipeContent = document.getElementById('recipe-content');
        const recipeFeedbackForm = document.getElementById('recipe-feedback-form');
        const recipeFeedbackList = document.getElementById('recipe-feedback-list');
        const recipeAvgRating = document.getElementById('recipe-avg-rating');
        const recipeFeedbackSection = document.getElementById('recipe-feedback-section');

        // --- Gemini API Configuration ---
        const API_KEY = "AIzaSyBwnXR2pgdAVplrWOrPTpxfY39eK14wb5E";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // --- Fonction API Gemini (avec recherche) ---
        async function callGeminiAPI(systemPrompt, userQuery, useSearchTool = true, retries = 3, delay = 1000) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            if (useSearchTool) {
                payload.tools = [{ "google_search": {} }];
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiAPI(systemPrompt, userQuery, useSearchTool, retries - 1, delay * 2);
                    }
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${errorBody.error?.message || response.statusText} (Status: ${response.status})`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                     if (result.promptFeedback?.blockReason) {
                         throw new Error(`La requête a été bloquée : ${result.promptFeedback.blockReason}`);
                    }
                    throw new Error('Réponse invalide ou vide de l\'API Gemini.');
                }
            } catch (error) {
                 console.error("Error calling Gemini API:", error);
                 throw error;
            }
        }
        
        // --- Logique de Recherche (inchangée) ---
        async function handleSearch() {
            const city = cityInput.value.trim();
            if (!city) {
                showError("Veuillez entrer une ville pour lancer la recherche.");
                return;
            }
            initialMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            resultsGrid.innerHTML = '';
            loader.style.display = 'flex';
            const specificSearch = specificSearchInput.value.trim();
            const sortOrder = sortSelect.value;
            const activeTags = Array.from(tagFiltersContainer.querySelectorAll('[data-active="true"]')).map(btn => btn.dataset.value);
            let userQuery = `Trouve les 6 meilleurs restaurants ou boutiques alimentaires à "${city}".`;
            if (specificSearch) userQuery += ` qui correspondent à "${specificSearch}".`;
            if (activeTags.length > 0) userQuery += ` Applique les filtres suivants : ${activeTags.join(', ')}.`;
            if (sortOrder) userQuery += ` Trie les résultats par : ${sortOrder}.`;
            const systemPrompt = `
                Tu es un guide local expert. Ta mission est de trouver des établissements réels et vérifiables.
                Réponds UNIQUEMENT avec un tableau JSON valide (une chaîne de caractères). N'inclus pas les \`\`\`json ... \`\`\` ou d'autres explications.
                Chaque objet doit contenir : "nom", "type", "description", "adresse", "note" (nombre), "prix", "telephone", "menu" (tableau de chaînes), "websiteUrl" (URL valide ou "non disponible"), et "imageUrls" (un tableau de 3 URLs d'images valides et directes de l'établissement).
                Utilise intensivement ton outil de recherche pour garantir que toutes les informations (surtout les URLs des images et du site) sont réelles, fonctionnelles et à jour.
            `;
            try {
                const responseText = await callGeminiAPI(systemPrompt, userQuery, true);
                const cleanedText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
                const results = JSON.parse(cleanedText);
                displayResults(results);
            } catch (error) {
                showError(`Désolé, une erreur est survenue. L'IA n'a pas pu formater les résultats. Essayez une autre recherche. Détail: ${error.message}`);
            } finally {
                loader.style.display = 'none';
            }
        }
        function displayResults(results) {
            resultsGrid.innerHTML = '';
            if (!results || results.length === 0) {
                 showError("Aucun résultat trouvé. Essayez d'élargir vos critères de recherche.");
                 return;
            }
            results.forEach(place => {
                const card = document.createElement('div');
                card.className = 'bg-slate-800 rounded-xl overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform duration-300 flex flex-col';
                card.innerHTML = `<div class="relative"><img src="${place.imageUrls[0]}" alt="Image de ${place.nom}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1e293b/94a3b8?text=Image+Indisponible';"></div><div class="p-5 flex flex-col flex-grow"><h3 class="text-xl font-bold text-green-400">${place.nom}</h3><p class="text-sm text-slate-400 mb-2">${place.type}</p><div class="flex items-center space-x-4 text-sm mb-3"><div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-400 mr-1"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg><span class="font-semibold">${place.note}</span></div><span class="font-bold text-slate-300">${place.prix}</span></div><p class="text-slate-300 text-sm leading-relaxed flex-grow">${place.description}</p></div>`;
                card.addEventListener('click', () => showDetailsModal(place));
                resultsGrid.appendChild(card);
            });
        }
        function showDetailsModal(place) {
            let imagesHTML = place.imageUrls.map(url => `<img src="${url}" class="w-full h-32 object-cover rounded-lg" onerror="this.style.display='none'">`).join('');
            let menuHTML = place.menu && place.menu.length > 0 ? `<h3 class="text-xl font-semibold mb-3 text-green-400">Menu / Produits Phares</h3><ul class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 mb-6 list-disc list-inside text-slate-300">${place.menu.map(item => `<li>${item}</li>`).join('')}</ul>` : '<p class="text-slate-400 mb-6">Le menu n\'est pas disponible actuellement.</p>';
            let websiteButton = place.websiteUrl && place.websiteUrl !== 'non disponible' ? `<a href="${place.websiteUrl}" target="_blank" class="inline-flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full w-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.72-1.72"></path></svg>Visiter le site web</a>` : '';
            modalContent.innerHTML = `<button class="close-modal-btn absolute top-4 right-4 text-slate-400 hover:text-white z-10 bg-slate-900/50 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button><img src="${place.imageUrls[0]}" alt="Image principale de ${place.nom}" class="w-full h-64 object-cover rounded-t-2xl" onerror="this.style.display='none'"><div class="p-6 md:p-8"><h2 class="text-3xl font-bold gradient-text mb-2">${place.nom}</h2><p class="text-slate-400 mb-4">${place.type}</p><div class="grid grid-cols-3 gap-2 mb-6">${imagesHTML}</div><p class="text-slate-300 mb-6">${place.description}</p>${menuHTML}<div class="border-t border-slate-700 pt-6 space-y-4"><p><strong>Adresse:</strong> ${place.adresse}</p><p><strong>Téléphone:</strong> ${place.telephone}</p><div class="grid grid-cols-1 ${websiteButton ? 'sm:grid-cols-2' : ''} gap-4"><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.adresse)}" target="_blank" class="inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full w-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>Itinéraire</a>${websiteButton}</div></div></div>`;
            detailsModal.classList.remove('hidden');
            detailsModal.classList.add('flex', 'modal-enter');
            detailsModal.classList.remove('modal-leave');
            detailsModal.querySelector('.close-modal-btn').addEventListener('click', hideDetailsModal);
        }
        function hideDetailsModal() {
            detailsModal.classList.add('modal-leave');
            detailsModal.classList.remove('modal-enter');
            setTimeout(() => { detailsModal.classList.add('hidden'); detailsModal.classList.remove('flex'); }, 300);
        }
        function showError(message) {
            resultsGrid.innerHTML = '';
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // --- Logique "Avis" (inchangée) ---
        const createStars = (rating) => {
            let stars = '';
            for (let i = 0; i < 5; i++) stars += i < rating ? '★' : '☆';
            return stars;
        };
        reviewForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const reviewerName = document.getElementById('reviewer-name').value;
            const placeName = document.getElementById('place-name').value;
            const reviewText = document.getElementById('review-text').value;
            const ratingValue = document.querySelector('input[name="rating"]:checked')?.value;
            if (!ratingValue) { return; }
            const newReview = document.createElement('div');
            newReview.className = 'bg-slate-900 p-6 rounded-xl';
            newReview.innerHTML = `<div class="flex items-start justify-between mb-2"><div><p class="font-bold text-lg">${reviewerName}</p><p class="text-sm text-slate-400">sur "${placeName}"</p></div><div class="text-yellow-400 text-xl">${createStars(ratingValue)}</div></div><p class="text-slate-300 mb-4">${reviewText}</p><div class="text-right"><button class="reply-btn text-sm text-blue-400 hover:underline">Répondre</button></div><div class="reply-section hidden mt-4 pl-6 border-l-2 border-slate-700"></div>`;
            reviewsList.prepend(newReview);
            reviewForm.reset();
        });
        reviewsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('reply-btn')) {
                const button = e.target;
                const replySection = button.closest('.bg-slate-900').querySelector('.reply-section');
                if (replySection.classList.contains('hidden')) {
                    button.textContent = 'Annuler';
                    replySection.classList.remove('hidden');
                    replySection.innerHTML = `<textarea rows="2" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2 mb-2" placeholder="Votre réponse..."></textarea><button class="post-reply-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md">Envoyer</button>`;
                } else {
                    button.textContent = 'Répondre';
                    replySection.classList.add('hidden');
                    replySection.innerHTML = '';
                }
            }
            if (e.target.classList.contains('post-reply-btn')) {
                 const replyButton = e.target;
                 const replySection = replyButton.parentElement;
                 const textarea = replySection.querySelector('textarea');
                 const replyText = textarea.value;
                 if (replyText.trim()) {
                     const newReply = document.createElement('div');
                     newReply.className = 'bg-slate-700/50 p-3 rounded-lg';
                     newReply.innerHTML = `<p class="font-bold text-sm">Votre réponse :</p><p class="text-slate-300 text-sm">${replyText}</p>`;
                     replySection.innerHTML = '';
                     replySection.appendChild(newReply);
                     replySection.parentElement.querySelector('.reply-btn').remove();
                 }
            }
        });

        // --- Logique Chatbot (inchangée) ---
        chatbotToggle.addEventListener('click', () => chatbotWindow.classList.toggle('hidden'));
        chatbotClose.addEventListener('click', () => chatbotWindow.classList.add('hidden'));
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            appendChatMessage(userMessage, 'user');
            chatInput.value = '';
            chatLoader.style.display = 'flex';
            const systemPrompt = `Vous êtes un assistant IA conversationnel spécialisé dans la gastronomie. Répondez de manière concise, amicale et informative en utilisant votre outil de recherche.`;
            try {
                const responseText = await callGeminiAPI(systemPrompt, userMessage, true);
                appendChatMessage(responseText, 'gemini');
            } catch (error) {
                appendChatMessage("Désolé, je ne peux pas répondre pour le moment.", 'gemini');
            } finally {
                chatLoader.style.display = 'none';
            }
        });
        function appendChatMessage(message, sender) {
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-lg max-w-xs ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-gemini'}`;
            bubble.textContent = message;
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // --- NOUVEAU: Logique Recette du Jour ---

        // 1. Ouvre la modale et lance le chargement
        async function openRecipeModal() {
            recipeModal.classList.remove('hidden');
            recipeModal.classList.add('flex', 'modal-enter');
            recipeContent.classList.add('hidden');
            recipeFeedbackSection.classList.add('hidden');
            recipeLoader.classList.remove('hidden');
            
            // Annule l'ancien écouteur s'il existe
            if (unsubscribeFeedback) {
                unsubscribeFeedback();
            }
            
            await loadRecipeOfTheDay();
        }
        
        // 2. Charge la recette (la génère si elle n'existe pas)
        async function loadRecipeOfTheDay() {
            const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
            const recipeDocRef = doc(db, "artifacts", appId, "public/data/recipe_of_the_day", today);
            
            try {
                const recipeDoc = await getDoc(recipeDocRef);
                let recipeData;
                
                if (recipeDoc.exists()) {
                    // La recette existe, on l'affiche
                    recipeData = recipeDoc.data();
                } else {
                    // La recette n'existe pas, on la génère
                    recipeData = await generateNewRecipe();
                    // On la sauvegarde dans Firestore pour les autres utilisateurs
                    await setDoc(recipeDocRef, recipeData);
                }
                
                displayRecipe(recipeData, today);
                loadFeedback(today); // Charge les commentaires
                
            } catch (error) {
                console.error("Erreur lors du chargement de la recette:", error);
                recipeContent.innerHTML = `<p class="p-8 text-center text-red-400">Erreur lors du chargement de la recette : ${error.message}</p>`;
                recipeContent.classList.remove('hidden');
            } finally {
                recipeLoader.classList.add('hidden');
                recipeFeedbackSection.classList.remove('hidden');
            }
        }
        
        // 3. Appelle Gemini pour générer une nouvelle recette
        async function generateNewRecipe() {
            const systemPrompt = `
                Vous êtes un chef cuisinier expert. Générez une recette unique et délicieuse.
                Répondez UNIQUEMENT avec un objet JSON valide (une chaîne de caractères). N'incluez pas les \`\`\`json ... \`\`\` ou d'autres explications.
                L'objet doit contenir : "title" (string), "description" (string, 1-2 phrases), "imageUrl" (une URL d'image de nourriture valide et pertinente), "ingredients" (tableau de strings), "instructions" (tableau de strings).
                Utilisez votre outil de recherche pour trouver une belle image.
            `;
            const userQuery = "Génère une recette de cuisine unique et de saison pour aujourd'hui.";
            
            const responseText = await callGeminiAPI(systemPrompt, userQuery, true); // true pour la recherche d'image
            const cleanedText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(cleanedText);
        }

        // 4. Affiche la recette dans la modale
        function displayRecipe(data, date) {
            recipeContent.innerHTML = `
                <img src="${data.imageUrl}" alt="Image de ${data.title}" class="w-full h-64 object-cover rounded-t-2xl" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1e293b/94a3b8?text=Image+Recette';">
                <div class="p-8">
                    <h2 class="text-3xl font-bold gradient-text mb-4">${data.title}</h2>
                    <p class="text-slate-300 mb-6">${data.description}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-green-400">Ingrédients</h3>
                            <ul class="list-disc list-inside space-y-1 text-slate-300">
                                ${data.ingredients.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-green-400">Préparation</h3>
                            <ol class="list-decimal list-inside space-y-2 text-slate-300">
                                ${data.instructions.map(item => `<li>${item}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                </div>
            `;
            recipeContent.classList.remove('hidden');
            // Stocke l'ID du document (la date) dans le formulaire pour savoir où poster le commentaire
            recipeFeedbackForm.dataset.recipeDate = date;
        }

        // 5. Charge les commentaires en temps réel avec onSnapshot
        function loadFeedback(date) {
            const feedbackColRef = collection(db, "artifacts", appId, "public/data/recipe_of_the_day", date, "feedback");
            const q = query(feedbackColRef);
            
            // onSnapshot écoute les changements en temps réel
            unsubscribeFeedback = onSnapshot(q, (snapshot) => {
                recipeFeedbackList.innerHTML = '';
                if (snapshot.empty) {
                    recipeFeedbackList.innerHTML = '<p class="text-slate-500 text-center">Soyez le premier à laisser un avis !</p>';
                    recipeAvgRating.innerHTML = '<p class="text-slate-400">Aucune note pour l'instant</p>';
                    return;
                }
                
                let totalRating = 0;
                let count = 0;
                
                snapshot.docs.forEach(doc => {
                    const feedback = doc.data();
                    const rating = Number(feedback.rating);
                    if (!isNaN(rating)) {
                        totalRating += rating;
                        count++;
                    }
                    
                    const feedbackEl = document.createElement('div');
                    feedbackEl.className = 'bg-slate-700/50 p-4 rounded-lg';
                    feedbackEl.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-bold text-slate-100">${feedback.userName || 'Anonyme'}</p>
                            <span class="text-yellow-400 text-lg">${createStars(feedback.rating)}</span>
                        </div>
                        <p class="text-slate-300">${feedback.comment}</p>
                    `;
                    recipeFeedbackList.appendChild(feedbackEl);
                });
                
                // Calcule et affiche la note moyenne
                const avg = (totalRating / count).toFixed(1);
                recipeAvgRating.innerHTML = `
                    <p class="text-3xl font-bold text-yellow-400">${avg} ★</p>
                    <p class="text-slate-400">basé sur ${count} avis</p>
                `;
            });
        }
        
        // 6. Gère la soumission d'un nouveau commentaire
        async function handleFeedbackSubmit(e) {
            e.preventDefault();
            const date = e.target.dataset.recipeDate;
            if (!date) return;
            
            const userName = document.getElementById('recipe-reviewer-name').value;
            const comment = document.getElementById('recipe-comment-text').value;
            const rating = document.querySelector('input[name="recipe-rating"]:checked')?.value;
            
            if (!rating) {
                alert("Veuillez sélectionner une note.");
                return;
            }
            
            const feedbackColRef = collection(db, "artifacts", appId, "public/data/recipe_of_the_day", date, "feedback");
            try {
                await addDoc(feedbackColRef, {
                    userName: userName,
                    comment: comment,
                    rating: Number(rating),
                    createdAt: new Date()
                });
                e.target.reset(); // Réinitialise le formulaire
            } catch (error) {
                console.error("Erreur lors de l'ajout du commentaire:", error);
                alert("Erreur lors de l'envoi de votre avis.");
            }
        }
        
        // 7. Ferme la modale de recette
        function closeRecipeModal() {
            recipeModal.classList.add('modal-leave');
            recipeModal.classList.remove('modal-enter');
            setTimeout(() => {
                recipeModal.classList.add('hidden');
                recipeModal.classList.remove('flex');
            }, 300);
            
            // Arrête d'écouter les commentaires lorsque la modale est fermée
            if (unsubscribeFeedback) {
                unsubscribeFeedback();
            }
        }

        // --- Initialisation et Event Listeners ---
        
        // Attache les écouteurs non dépendants de Firebase
        searchButton.addEventListener('click', handleSearch);
        document.getElementById('search-form').addEventListener('submit', (e) => { e.preventDefault(); handleSearch(); });
        tagFiltersContainer.addEventListener('click', (e) => { if (e.target.classList.contains('filter-btn')) { const btn = e.target; btn.dataset.active = !(btn.dataset.active === 'true'); }});
        detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) { hideDetailsModal(); } });
        openAboutModalBtn.addEventListener('click', () => { aboutModal.classList.remove('hidden'); aboutModal.classList.add('flex', 'modal-enter'); });
        closeAboutModalBtn.addEventListener('click', () => { aboutModal.classList.add('modal-leave'); setTimeout(() => aboutModal.classList.add('hidden'), 300); });
        aboutModal.addEventListener('click', (e) => { if (e.target === aboutModal) { closeAboutModalBtn.click(); } });

        // NOUVEAU: Écouteurs pour la modale de recette
        closeRecipeModalBtn.addEventListener('click', closeRecipeModal);
        recipeModal.addEventListener('click', (e) => { if (e.target === recipeModal) { closeRecipeModal(); } });

        // --- Initialisation de Firebase et Authentification ---
        try {
            // @ts-ignore
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // @ts-ignore
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            setLogLevel('Debug'); // Active les logs pour le débogage

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Utilisateur authentifié:", user.uid);
                    userId = user.uid;
                    
                    // Attache les écouteurs qui dépendent de l'authentification
                    recipeFeedbackForm.addEventListener('submit', handleFeedbackSubmit);
                    openRecipeModalBtn.addEventListener('click', openRecipeModal);
                    
                } else {
                    console.log("Utilisateur non authentifié.");
                    userId = null;
                }
            });

            // @ts-ignore
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                // @ts-ignore
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            
        } catch (error) {
            console.error("Erreur d'initialisation de Firebase:", error);
            showError("Erreur critique: Impossible de se connecter à la base de données. " + error.message);
        }

    </script>
</body>
</html>


